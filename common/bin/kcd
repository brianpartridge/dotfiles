#!/usr/bin/env ruby

require 'tempfile'
require_relative 'lib/utils'

# Open the current specified files in Kaledoscope
def diff(left, right)
   lpath = write_temp_file(left)
   rpath = write_temp_file(right)
   `/usr/local/bin/ksdiff #{lpath} #{rpath}`
end

# Parse known formats into left and right content
def parse_clipboard
   content = `pbpaste`
   
   match_data = parse_equal_assertion(content)
   return [match_data['left'], match_data['right']] if match_data
   
   match_data = parse_merge_confict(content)
   return [match_data['left'], match_data['right']] if match_data
   
   fatal "Unable to parse input."
end

def parse_equal_assertion(content)
  content.match(/XCTAssertEqual failed: \((?<left>.*)\) is not equal to \((?<right>.*)\) -/)
end

def parse_merge_confict(content)
  
end

# Write a temporary file with the specified content
def write_temp_file(content)
  f = Tempfile.new('kxd')
  f.write(content)
  f.close
  f.path
end

# Main entry point, checks the clipboard for diffable content and opens it in a diff viewer.
def run!
  parts = parse_clipboard()
  diff(parts.first, parts.last)
end

run!

